{% extends "billy/web/public/base.html" %}
{% load i18n %}
{% load url from future %}
{% load customtags %}
{% load static from staticfiles %}

{% block title %}{{state.name}} {% trans "events" %}{% endblock %}

{% block headblock %}

<script src="{% static 'js/datatables.js' %}"></script>
<script src="{% static 'js/jquery.pjax.min.js' %}"></script>
<script>
$(document).ready(function() {

    // Where 'current' refers to the current state of the calendar widget.
    window.current_month = {{now.month}};
    window.current_year = {{now.year}};

    var doc = $(this);
    // $("#calendar").calendarWidget();

    // See the template include for #data-main.
    $(this).pjax('a', '#events-pjax');


    var update_calendar = function(month, year){
      console.log('Updating calendar to month: ' + month + ', and year: ' + year);

      $("#calendar").calendarWidget({month: month, year: year});
      var url = '/{{abbr}}/events/json_for_date/' + year + '/' + month + '/';
      $.getJSON(url, function(data){
        $.each(data, function(i, event_){

          // Serialized dates are seconds since the epoch. We need millisecs.
          var event_date = new Date(event_.when * 1000),
              event_month = event_date.getMonth(),
              event_year = event_date.getYear();
          if (event_month === month && event_year === year) {
            var day = $('.day' + event_date.getDay());
            // Append a dot to this day on the calendar.
            day.append('<span class="events">' + event_.description + '</span>');
            }
        });
      });
      window.current_month = month;
      window.current_year = year;

      doc.trigger('calendar:redraw');
    }

    // Load events for the current year on page load.
    update_calendar({{now.month}} - 1, {{now.year}});

    // The calendar has been rendered; now we can bind functions to the it.
    // Update the calendar on pressing the month nav links on the calendar.
    function bind_nav_prev(){
      $('#calendar .nav-prev').click(function(){
        var prev_month, prev_year;

        // If current month is January...
        if (window.current_month == 0) {
          prev_month = 11;
          prev_year = window.current_year - 1;
        } else {
          prev_month = window.current_month - 1;
          prev_year = window.current_year;
        }
        update_calendar(prev_month, prev_year)
        });
    }

    function bind_nav_next() {
      $('#calendar .nav-next').click(function(){
        var next_month, next_year;
        // If current month is January...
        if (window.current_month == 11) {
          next_month = 0;
          next_year = window.current_year + 1;
        } else {
          next_month = window.current_month + 1;
          next_year = window.current_year;
        }
        update_calendar(next_month, next_year)
        });
    }

    // Tell pjax not to jump to the top of the
    // page after loading.
    $.pjax.defaults.scrollTo = false;

    // When the pjax operation is done, re-run pjax_setup to bind
    // the various calendar listeners.
    doc.bind('calendar:redraw', {}, bind_nav_prev);
    doc.bind('calendar:redraw', {}, bind_nav_next);

    doc.trigger('calendar:redraw');

});
</script>
{% endblock %}

{% block content %}
<div class="fullWidth module clear">
<h2>{% trans "Past & Future events" %}</h2>
</div>
<div class="calendar fourCol colLt">
  <div id="calendar">
    <p>Please enable Javascript to view this calendar.</p>
  </div>
</div>
<div class="eightCol colRt">
{% include "billy/web/public/events-pjax.html" %}
</div>
<div class="clear"></div>

{% endblock %}